<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Session Analysis – Module 2</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #cceeff;
      font-family: Arial, sans-serif;
      color: #000;
      padding: 20px;
    }
    input, button, select {
      padding: 10px;
      margin: 5px 0;
      background: #fff;
      border: 1px solid #ccc;
      width: 100%;
      font-size: 16px;
    }
    textarea {
      padding: 10px;
      margin: 5px 0;
      background: #fff;
      border: 1px solid #ccc;
      width: 100%;
      font-family: monospace;
      font-size: 14px;
    }
    h1, h2 {
      margin-top: 30px;
    }
    .section {
      margin-bottom: 30px;
    }
    .chart-container {
      width: 100%;
      max-width: 600px;
      margin-top: 20px;
    }
    .result-label {
      font-weight: bold;
      margin-top: 15px;
    }
    button.analyze {
      font-weight: bold;
      text-transform: uppercase;
      background-color: green;
      color: white;
    }
    button.analyzed {
      background-color: blue;
      color: white;
    }
    .highlight {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Manual Best Lap Analysis – Sessions 2 & 3</h1>

  <div class="section">
    <h2>Session 2</h2>
    <label>Reference Time (m:ss.mmm):</label>
    <input id="refTime2" maxlength="7" type="text" placeholder="e.g. 123456" oninput="autoFormat(this)"/>
    <textarea id="session2Times" rows="5" placeholder="Enter lap times (e.g. 123456)" oninput="processLapStream(this)"></textarea>
    <button id="btn2" class="analyze" onclick="processTimes('session2')">ANALYZE SESSION 2</button>
    <ul id="session2Result"></ul>
    <p class="result-label">Session 2 Delta Sum: <span id="session2Sum">-</span> ms</p>
    <div class="chart-container"><canvas id="chart2"></canvas></div>
  </div>

  <div class="section">
    <h2>Session 3</h2>
    <label>Reference Time (m:ss.mmm):</label>
    <input id="refTime3" maxlength="7" type="text" placeholder="e.g. 123456" oninput="autoFormat(this)"/>
    <textarea id="session3Times" rows="5" placeholder="Enter lap times (e.g. 123456)" oninput="processLapStream(this)"></textarea>
    <button id="btn3" class="analyze" onclick="processTimes('session3')">ANALYZE SESSION 3</button>
    <ul id="session3Result"></ul>
    <p class="result-label">Session 3 Delta Sum: <span id="session3Sum">-</span> ms</p>
    <div class="chart-container"><canvas id="chart3"></canvas></div>
  </div>

  <div class="section">
    <h2>Final Results</h2>
    <p class="result-label">Total Delta (Session 2 + 3): <span id="totalSum">-</span> ms</p>
  </div>

  <script>
    function parseTimeString(timeStr) {
      const match = timeStr.match(/(\d+):(\d{2})\.(\d{3})/);
      if (!match) return null;
      const [_, min, sec, ms] = match;
      if (+sec > 59) return null;
      return (+min * 60 + +sec) * 1000 + +ms;
    }

    function formatMs(ms) {
      const min = Math.floor(ms / 60000);
      const sec = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
      const milli = (ms % 1000).toString().padStart(3, '0');
      return `${min}:${sec}.${milli}`;
    }

    function autoFormat(input) {
      let val = input.value.replace(/[^\d]/g, '');
      if (val.length > 6) val = val.slice(0, 6);
      if (val.length < 6) return;
      const m = val[0];
      const s = val.slice(1, 3);
      const ms = val.slice(3);
      if (+s > 59) return;
      input.value = `${m}:${s}.${ms}`;
    }

    function processLapStream(textarea) {
      const raw = textarea.value.replace(/[^\d]/g, '');
      let result = [];
      for (let i = 0; i < raw.length; i += 6) {
        const block = raw.slice(i, i + 6);
        if (block.length === 6) {
          const m = block[0];
          const s = block.slice(1, 3);
          const ms = block.slice(3);
          if (+s <= 59) result.push(`${m}:${s}.${ms}`);
        }
      }
      textarea.value = result.join('\n');
    }

    let sessionSums = { session2: 0, session3: 0 };

    function processTimes(session) {
      const refInput = document.getElementById(`refTime${session.slice(-1)}`);
      const refTime = parseTimeString(refInput.value);
      if (refTime === null) return alert("Invalid reference time format or seconds > 59. Use m:ss.mmm");

      const textArea = document.getElementById(`${session}Times`);
      const lines = textArea.value.trim().split('\n');
      const deltas = [];

      lines.forEach((line, index) => {
        const lap = parseTimeString(line);
        if (lap !== null) {
          const delta = Math.abs(lap - refTime);
          deltas.push({ index, line, delta });
        }
      });

      deltas.sort((a, b) => a.delta - b.delta);
      const best5 = deltas.slice(0, 5);
      const listEl = document.getElementById(`${session}Result`);
      listEl.innerHTML = '';
      let sum = 0;
      best5.forEach((item, i) => {
        sum += item.delta;
        const li = document.createElement('li');
        li.textContent = `#${i + 1}: ${item.line} (Δ ${item.delta} ms)`;
        listEl.appendChild(li);
      });

      document.getElementById(`${session}Sum`).textContent = sum;
      sessionSums[session] = sum;
      document.getElementById('totalSum').textContent = sessionSums.session2 + sessionSums.session3;

      const ctx = document.getElementById(`chart${session.slice(-1)}`).getContext('2d');
      if (window[`chart${session}`]) window[`chart${session}`].destroy();
      window[`chart${session}`] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: best5.map((_, i) => `Lap ${i + 1}`),
          datasets: [{
            label: 'Delta (ms)',
            backgroundColor: '#0077cc',
            data: best5.map(d => d.delta)
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });

      const highlighted = lines.map((line, idx) => {
        const highlight = best5.find(d => d.index === idx);
        return highlight ? `**${line}**` : line;
      });
      textArea.value = highlighted.join('\n');

      const btn = document.getElementById(`btn${session.slice(-1)}`);
      btn.classList.remove('analyze');
      btn.classList.add('analyzed');

      textArea.oninput = () => {
        btn.classList.remove('analyzed');
        btn.classList.add('analyze');
      };
    }
  </script>
</body>
</html>
