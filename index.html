<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Session Analysis – Module 2</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #cceeff;
      font-family: Arial, sans-serif;
      color: #000;
      padding: 20px;
    }
    input, textarea, button {
      padding: 10px;
      margin: 5px 0;
      background: #fff;
      border: 1px solid #ccc;
      width: 100%;
    }
    h1, h2 {
      margin-top: 30px;
    }
    .section {
      margin-bottom: 30px;
    }
    .chart-container {
      width: 100%;
      max-width: 600px;
      margin-top: 20px;
    }
    .result-label {
      font-weight: bold;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <h1>Manual Best Lap Analysis – Sessions 2 & 3</h1>

  <div class="section">
    <h2>Session 2</h2>
    <label for="refTime2">Reference Time (m:ss.mmm):</label>
    <input id="refTime2" type="text" placeholder="1:20.000" />
    <textarea id="session2Times" rows="5" placeholder="Enter lap times, one per line"></textarea>
    <button onclick="processTimes('session2')">Analyze Session 2</button>
    <ul id="session2Result"></ul>
    <p class="result-label">Session 2 Delta Sum: <span id="session2Sum">-</span> ms</p>
    <div class="chart-container"><canvas id="chart2"></canvas></div>
  </div>

  <div class="section">
    <h2>Session 3</h2>
    <label for="refTime3">Reference Time (m:ss.mmm):</label>
    <input id="refTime3" type="text" placeholder="1:18.500" />
    <textarea id="session3Times" rows="5" placeholder="Enter lap times, one per line"></textarea>
    <button onclick="processTimes('session3')">Analyze Session 3</button>
    <ul id="session3Result"></ul>
    <p class="result-label">Session 3 Delta Sum: <span id="session3Sum">-</span> ms</p>
    <div class="chart-container"><canvas id="chart3"></canvas></div>
  </div>

  <div class="section">
    <h2>Final Results</h2>
    <p class="result-label">Total Delta (Session 2 + 3): <span id="totalSum">-</span> ms</p>
  </div>

  <script>
    function parseTime(str) {
      const match = str.match(/^(\d+):(\d{2})\.(\d{1,3})$/);
      if (!match) return null;
      const [_, min, sec, ms] = match;
      return (+min * 60 + +sec) * 1000 + +ms.padEnd(3, '0');
    }

    function formatMs(ms) {
      const min = Math.floor(ms / 60000);
      const sec = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
      const milli = (ms % 1000).toString().padStart(3, '0');
      return `${min}:${sec}.${milli}`;
    }

    let sessionSums = {
      session2: 0,
      session3: 0
    };

    function processTimes(session) {
      const refInputId = session === 'session2' ? 'refTime2' : 'refTime3';
      const refTimeStr = document.getElementById(refInputId).value;
      const refMs = parseTime(refTimeStr);
      if (!refMs) {
        alert('Invalid reference time for ' + session);
        return;
      }

      const inputId = session + 'Times';
      const resultId = session + 'Result';
      const chartId = session === 'session2' ? 'chart2' : 'chart3';
      const sumId = session + 'Sum';

      const lines = document.getElementById(inputId).value.trim().split('\n');
      const deltas = lines.map(t => {
        const lapMs = parseTime(t.trim());
        if (lapMs === null) return null;
        const delta = Math.abs(lapMs - refMs);
        return { original: t.trim(), delta };
      }).filter(Boolean).sort((a, b) => a.delta - b.delta);

      const best5 = deltas.slice(0, 5);
      const listEl = document.getElementById(resultId);
      listEl.innerHTML = '';
      let sum = 0;
      best5.forEach((item, i) => {
        sum += item.delta;
        const li = document.createElement('li');
        li.textContent = `#${i + 1}: ${item.original} (Δ ${item.delta} ms)`;
        listEl.appendChild(li);
      });

      sessionSums[session] = sum;
      document.getElementById(sumId).textContent = sum;
      document.getElementById('totalSum').textContent = sessionSums.session2 + sessionSums.session3;

      renderChart(chartId, best5);
    }

    function renderChart(id, data) {
      const ctx = document.getElementById(id).getContext('2d');
      if (window[id]) window[id].destroy();
      window[id] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map((_, i) => `Lap ${i + 1}`),
          datasets: [{
            label: 'Delta (ms)',
            backgroundColor: '#0077cc',
            data: data.map(d => d.delta)
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }
  </script>
</body>
</html>
